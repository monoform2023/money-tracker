let cashBalance = 0;
let cardBalance = 0;
let history = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
if (localStorage.getItem("cashBalance")) {
    cashBalance = parseFloat(localStorage.getItem("cashBalance"));
    cardBalance = parseFloat(localStorage.getItem("cardBalance"));
    history = JSON.parse(localStorage.getItem("history"));
    updateBalances();
    updateHistory();
}

function addTransaction() {
    const type = document.getElementById("type").value;
    const method = document.getElementById("method").value;
    const amount = parseFloat(document.getElementById("amount").value);
    const description = document.getElementById("description").value;

    if (isNaN(amount) || amount <= 0) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
        return;
    }

    if (type === "–¥–æ—Ö–æ–¥") {
        if (method === "–Ω–∞–ª–∏—á–Ω—ã–µ") cashBalance += amount;
        else if (method === "–±–µ–∑–Ω–∞–ª") cardBalance += amount;
    } else if (type === "—Ä–∞—Å—Ö–æ–¥") {
        if (method === "–Ω–∞–ª–∏—á–Ω—ã–µ") cashBalance -= amount;
        else if (method === "–±–µ–∑–Ω–∞–ª") cardBalance -= amount;
    }

    const transaction = {
        date: new Date().toLocaleString(),
        type: type,
        method: method,
        amount: amount,
        description: description
    };
    history.push(transaction);

    updateBalances();
    updateHistory();
    saveToLocalStorage();

    document.getElementById("amount").value = "";
    document.getElementById("description").value = "";
}

function updateBalances() {
    document.getElementById("cashBalance").textContent = cashBalance.toFixed(2);
    document.getElementById("cardBalance").textContent = cardBalance.toFixed(2);
    document.getElementById("totalBalance").textContent = (cashBalance + cardBalance).toFixed(2);
}

function updateHistory() {
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";

    history.forEach((transaction, index) => {
        const row = document.createElement("tr");
        row.classList.add(transaction.type === "–¥–æ—Ö–æ–¥" ? "income-row" : "expense-row");

        row.innerHTML = `
            <td>${transaction.date.split(",")[0]}</td> <!-- –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è -->
            <td>${transaction.method}</td>
            <td>${transaction.amount.toFixed(2)}</td>
            <td>${transaction.description}</td>
            <td><button class="delete-btn" onclick="deleteTransaction(${index})">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(row);
    });
}

function deleteTransaction(index) {
    const transaction = history[index];
    if (transaction.type === "–¥–æ—Ö–æ–¥") {
        if (transaction.method === "–Ω–∞–ª–∏—á–Ω—ã–µ") cashBalance -= transaction.amount;
        else if (transaction.method === "–±–µ–∑–Ω–∞–ª") cardBalance -= transaction.amount;
    } else if (transaction.type === "—Ä–∞—Å—Ö–æ–¥") {
        if (transaction.method === "–Ω–∞–ª–∏—á–Ω—ã–µ") cashBalance += transaction.amount;
        else if (transaction.method === "–±–µ–∑–Ω–∞–ª") cardBalance += transaction.amount;
    }

    history.splice(index, 1);
    updateBalances();
    updateHistory();
    saveToLocalStorage();
}

function applyFiltersAndSearch() {
    const filterType = document.getElementById("filterType").value;
    const filterMethod = document.getElementById("filterMethod").value;
    const searchQuery = document.getElementById("searchQuery").value.toLowerCase();

    const filteredHistory = history.filter(transaction => {
        const matchesType = filterType === "–≤—Å–µ" || transaction.type === filterType;
        const matchesMethod = filterMethod === "–≤—Å–µ" || transaction.method === filterMethod;
        const matchesSearch = transaction.description.toLowerCase().includes(searchQuery);
        return matchesType && matchesMethod && matchesSearch;
    });

    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";

    filteredHistory.forEach(transaction => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${transaction.date}</td>
            <td>${transaction.type}</td>
            <td>${transaction.method}</td>
            <td>${transaction.amount.toFixed(2)}</td>
            <td>${transaction.description}</td>
            <td><button class="delete-btn" onclick="deleteTransaction(${history.indexOf(transaction)})">‚úñ</button></td>
        `;
        tbody.appendChild(row);
    });
}

function analyzeByDateRange() {
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);

    if (isNaN(startDate) || isNaN(endDate)) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç!");
        return;
    }

    const analysis = { –¥–æ—Ö–æ–¥: 0, —Ä–∞—Å—Ö–æ–¥: 0 };
    history.forEach(transaction => {
        const transactionDate = new Date(transaction.date);
        if (transactionDate >= startDate && transactionDate <= endDate) {
            analysis[transaction.type] += transaction.amount;
        }
    });

    const result = `
        <h3>–ê–Ω–∞–ª–∏–∑ –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>
        <p>–î–æ—Ö–æ–¥: ${analysis.–¥–æ—Ö–æ–¥.toFixed(2)}</p>
        <p>–†–∞—Å—Ö–æ–¥: ${analysis.—Ä–∞—Å—Ö–æ–¥.toFixed(2)}</p>
    `;
    document.getElementById("analysisResult").innerHTML = result;
}

function exportToXLSX() {
    const wsData = history.map(transaction => [
        transaction.date,
        transaction.type,
        transaction.method,
        transaction.amount,
        transaction.description
    ]);

    const ws = XLSX.utils.aoa_to_sheet([
        ["–î–∞—Ç–∞", "–¢–∏–ø", "–ú–µ—Ç–æ–¥", "–°—É–º–º–∞", "–û–ø–∏—Å–∞–Ω–∏–µ"],
        ...wsData
    ]);

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏");
    XLSX.writeFile(wb, "transactions.xlsx");
}

function toggleSection(id) {
    const content = document.getElementById(id);
    if (content.style.display === "block") {
        content.style.display = "none";
    } else {
        content.style.display = "block";
    }
}

function saveToLocalStorage() {
    localStorage.setItem("cashBalance", cashBalance);
    localStorage.setItem("cardBalance", cardBalance);
    localStorage.setItem("history", JSON.stringify(history));
}